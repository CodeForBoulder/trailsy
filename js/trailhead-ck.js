function startup(){function P(){}function H(){console.log("initialSetup");U();z();W(w,function(){K(function(){et(d)})});h&&Y(function(){})}function B(){R();W(w,function(){et(d)})}function F(e,t){var n=$.extend(!0,{},t);$.each(t,function(t,r){if(e.activityFilter)for(var i=0;i<e.activityFilter.length;i++){var s=e.activityFilter[i];r.properties[s]&&r.properties[s].toLowerCase().charAt(0)!=="y"&&delete n[t]}if(e.lengthFilter){var o=!1;for(var u=0;u<e.lengthFilter.length;u++){var c=e.lengthFilter[u],h=r.properties.length;if(c.toLowerCase()=="short"&&h<=a||c.toLowerCase()=="medium"&&h>a&&h<=f||c.toLowerCase()=="long"&&h>f&&h<=l||c.toLowerCase()=="verylong"&&h>l){o=!0;break}}o||delete n[t]}});et(n)}function I(e){var t=$(e.currentTarget);console.log(t);var n=t.attr("data-filter"),r=t.val();console.log(r);q(n,r)}function q(e,t){console.log(t);var n=0;if(e=="activityFilter"){var r=E.activityFilter.length;for(i=0;i<E.activityFilter.length;i++){var s=E.activityFilter[i];if(s===t){E.activityFilter.splice(i,1);n=1;break}}n===0&&E.activityFilter.push(t)}if(e=="lengthFilter"){console.log("length");console.log(E.lengthFilter.length);var r=E.lengthFilter.length;for(j=0;j<r;j++){console.log("j");console.log(j);var o=E.lengthFilter[j];if(o==t){console.log("match");E.lengthFilter.splice(j,1);n=1;break}}n===0&&E.lengthFilter.push(t)}console.log(E);F(E,d)}function R(){w=p.getCenter()}function U(){w=t}function z(){console.log("displayInitialMap");console.log(w);p=L.map("trailMap",{zoomControl:!1}).addControl(L.control.zoom({position:"topright"})).setView([w.lat,w.lng],11);L.tileLayer.provider("MapBox."+e).addTo(p);p.on("locationfound",function(e){N||(N=L.userMarker(e.latlng,{smallIcon:!0,pulsing:!0,accuracy:0}).addTo(p));console.log(e.latlng);N.setLatLng(e.latlng)});p.locate({watch:!0,setView:!1,enableHighAccuracy:!0});p.on("zoomend",function(e){console.log("zoomend");if(c&&C){p.getZoom()>=u&&!p.hasLayer(C)&&p.addLayer(C);p.getZoom()<u&&p.hasLayer(C)&&p.removeLayer(C)}});p.on("locationerror",function(e){console.log("Location Error:");console.log(e.message);console.log(e.code)})}function W(e,t){console.log("getOrderedTrailheads");var n={loc:e.lat+","+e.lng,type:"GET",path:"/trailheads.json?loc="+e.lat+","+e.lng};Lt(n,function(e){V(e);typeof t=="function"&&t()})}function X(e,t){console.log("getOrderedTrailheads");var n="select trailheads.*, ST_Distance_Sphere(ST_WKTToSQL('POINT("+e.lng+" "+e.lat+")'), the_geom) distance "+"from "+M+" as trailheads "+"ORDER BY distance "+"";At(n,function(e){V(e);typeof t=="function"&&t()})}function V(e){console.log("populateTrailheadArray");console.log(e);v=[];for(var t=0;t<e.features.length;t++){var n=e.features[t],r=new L.LatLng(n.geometry.coordinates[1],n.geometry.coordinates[0]),i=L.marker(r,{icon:A});i.on("click",function(e){return function(){J(e)}}(n.properties.id));var s={properties:n.properties,marker:i,trails:[],popupContent:""};v.push(s)}}function J(e){console.log("trailheadMarkerClick");gt(e,0)}function K(e){console.log("getTrailData");var t={type:"GET",path:"/trails.json"};Lt(t,function(t){G(t);typeof e=="function"&&e()})}function Q(e){console.log("getTrailData");var t="select * from "+D+" order by name";At(t,function(t){G(t);typeof e=="function"&&e()})}function G(e){for(var t=0;t<e.features.length;t++)d[e.features[t].properties.id]=e.features[t]}function Y(e){console.log("getTrailSegments");var t={type:"GET",path:"/trailsegments.json"};Lt(t,function(t){m=t;C=Z(t);typeof e=="function"&&e()})}function Z(e){C=L.geoJson(m,{style:function(){return{color:"#CC8464",weight:3,opacity:1,clickable:!0}},onEachFeature:function(e,t){var n="<div class='trail-popup'>";e.properties.trail1&&(n+=e.properties.trail1);e.properties.trail2&&(n=n+"<br>"+e.properties.trail2);e.properties.trail3&&(n=n+"<br>"+e.properties.trail3);e.properties.trail4&&(n=n+"<br>"+e.properties.trail4);e.properties.trail5&&(n=n+"<br>"+e.properties.trail5);e.properties.trail6&&(n=n+"<br>"+e.properties.trail6);n+="</div>";t.bindPopup(n)}});return C}function et(e){console.log("addTrailDataToTrailheads");console.log(d);for(var t=0;t<v.length;t++){var n=v[t];n.trails=[];for(var r=1;r<=3;r++){var i="trail"+r;if(n.properties[i]==="")continue;var s=n.properties[i];$.each(e,function(e,t){n.properties[i]==t.properties.name&&n.trails.push(e)})}}tt(v);nt(v);rt(v);it(v)}function tt(e){console.log("fixDuplicateTrailNames");for(var t=0;t<e.length;t++){var n=e[t],r={};for(var i=0;i<n.trails.length;i++){var s=d[n.trails[i]].properties.name;r[s]=r[s]||[];var o={source:d[n.trails[i]].properties.source,trailID:d[n.trails[i]].properties.id};r[s].push(o)}for(var u in r)if(r.hasOwnProperty(u)&&r[u].length>1)for(var a=0;a<r[u].length;a++){var f=r[u][a];if(f.source!=n.properties.source){var l=f.trailID,c=$.inArray(l.toString(),n.trails);n.trails.splice(c,1)}}}}function nt(e){for(var t=0;t<e.length;t++){var n=e[t],r=$("<div>").addClass("trailhead-popup"),i=$("<div>").addClass("trailhead-name").html($("<div>"+n.properties.name+"</div>")).appendTo(r);for(var s=0;s<n.trails.length;s++){var o=d[n.trails[s]],u=$("<div>").addClass("trailhead-trailname trail"+(s+1)).attr("data-trailname",o.properties.name).attr("data-trailid",o.properties.id).attr("data-trailheadname",n.properties.name).attr("data-trailheadid",n.properties.id).attr("data-index",s);console.log(o.properties.status);var a="";o.properties.status==1&&u.append($("<img>").addClass("status").attr({src:"img/icon_alert_yellow.png",title:"alert"}));o.properties.status==2&&u.append($("<img>").addClass("status").attr({src:"img/icon_alert_yellow.png",title:"alert"}));u.append("<div>"+o.properties.name+"</div>");u.append("<b>").appendTo(i)}n.popupContent=r.outerHTML()}}function rt(e){console.log("mapActiveTrailheads");var t=[];for(var n=0;n<e.length;n++)e[n].trails.length&&t.push(e[n].marker);var r=L.layerGroup(t);p.addLayer(r)}function it(e){console.log("makeTrailDivs");$("#trailList").html("");$.each(e,function(e,t){var n=t.properties.name,r=t.properties.id,i=t.trails;if(i.length===0)return!0;var s=t.properties.source,o=st(t.properties.distance),u;for(var a=0;a<i.length;a++){var f=i[a],l=d[f],c=d[f].properties.name,h=d[f].properties.length;u=$("<div>").addClass("trail-box").attr("data-source","list").attr("data-trailid",f).attr("data-trailname",c).attr("data-trail-length",h).attr("data-trailheadName",n).attr("data-trailheadid",r).attr("data-index",a).appendTo("#trailList").click(dt).click(function(e,t){return function(n){ot(e,t)}}(l,t));$trailIndicator=$("<div>").addClass("trailIndicatorLight").appendTo(u);$("<div class='trail' >"+c+"</div>").appendTo(u);$("<div class='trailheadName' >"+n+"</div>").appendTo(u);$("<div class='trailheadDistance' >"+o+" miles away"+"</div>").appendTo(u);$("<div class='trailSource' id='"+s+"'>"+s+"</div>").appendTo(u);$("<div class='trailLength' >"+h+" miles long"+"</div>").appendTo(u);var p={trailID:f,trailheadID:r,index:a};S.push(p)}if(i.length===0){u=$("<div class='trail-box'>").appendTo("#trailList");$("<span class='trail' id='list|"+n+"'>"+n+" - NO TRAILS ("+[val.properties.trail1,val.properties.trail2,val.properties.trail3].join(", ")+")</span>").appendTo(u);$("<span class='trailSource'>"+s+"</span>").appendTo(u)}});console.log(S)}function st(e){return(e*r).toFixed(1)}function ot(e,t){console.log("showTrailDetails");if($(".detailPanel").is(":hidden")){ct(e,t);ut();x=e;T=t}else if(x==e&&T==t){x=null;T=null;at()}else{ct(e,t);x=e;T=t}}function ut(){console.log("openDetailPanel");$(".detailPanel").show();$(".accordion").hide();p.invalidateSize()}function at(){console.log("closeDetailPanel");$(".detailPanel").hide();$(".accordion").show();p.invalidateSize()}function ft(){console.log("toggleDetailPanelControls");$(".detailPanelControls").toggle()}function lt(e){console.log("changeDetailPanel");var t=T.properties.id,n=String(x.properties.id);console.log(n);var r,i;for(var s=0;s<S.length;s++)S[s]["trailID"]==n&&S[s]["trailheadID"]==t&&(i=s);console.log(["orderedTrailIndex",i]);if($(e.target).hasClass("controlRight")){i+=1;console.log(["++orderedTrailIndex",i])}if($(e.target).hasClass("controlLeft")){i-=1;console.log(["--orderedTrailIndex",i])}var o=S[i];console.log(o);var t=o.trailheadID;console.log(["trailheadID",t]);var u=o.index;console.log(["trailIndex",u]);for(j=0;j<v.length;j++)v[j].properties.id==t&&(r=v[j]);gt(t,u);ot(d[r.trails[u]],r)}function ct(e,t){$(".detailPanel .detailPanelBanner .trailName").html(e.properties.name);$(".detailPanel .detailTrailheadName").html(t.properties.name);$(".detailPanel .detailSource").html(t.properties.source);$(".detailPanel .detailTrailheadDistance").html(st(t.properties.distance)+" miles away");$(".detailPanel .detailLength").html(e.properties.length+" miles");$(".detailPanel .detailDifficulty").html(e.properties.difficulty);$(".detailPanel .detailDescription").html(e.properties.description)}function ht(e){console.log("trailnameClick");vt(e)}function pt(e){console.log(e);var t=e.data("trailheadid"),n=e.data("index")||0,r=e.data("trailid");results={trailheadID:t,highlightedTrailIndex:n,trailID:r};return results}function dt(e){console.log("populateTrailsForTrailheadDiv");var t;e.target!==this?t=$(this):t=$(e.target);var n=pt(t);gt(n.trailheadID,n.highlightedTrailIndex)}function vt(e){console.log($(e.target).data("trailheadid"));var t;$(e.target).data("trailheadid")?t=$(e.target):t=$(e.target.parentNode);var n=pt(t);console.log(n);for(var r=0;r<v.length;r++)v[r].properties.id==n.trailheadID&&(trailhead=v[r]);gt(n.trailheadID,n.highlightedTrailIndex);var i=d[n.trailID];ot(i,trailhead)}function gt(e,t){console.log("highlightTrailhead");for(var n=0;n<v.length;n++)v[n].properties.id==e&&(currentTrailhead=v[n]);mt&&p.removeLayer(mt);mt=new L.Marker([currentTrailhead.marker.getLatLng().lat,currentTrailhead.marker.getLatLng().lng]);mt.addTo(p).bindPopup(currentTrailhead.popupContent);yt(currentTrailhead,t);mt.openPopup()}function yt(e,t){console.log("getAllTrailPathsForTrailhead");m.type=="FeatureCollection"&&h?wt(e,t):bt(e,t)}function bt(e,t){console.log("getAllTrailPathsForTrailheadRemote");var n=[],r=[];for(var i=0;i<e.trails.length;i++){var s=e.trails[i],o=d[s].properties.name,u="select st_collect(the_geom) the_geom, '"+o+"' trailname from "+_+" segments where "+"(segments.trail1 = '"+o+"' or "+"segments.trail2 = '"+o+"' or "+"segments.trail3 = '"+o+"' or "+"segments.trail4 = '"+o+"' or "+"segments.trail5 = '"+o+"' or "+"segments.trail6 = '"+o+"' or "+"segments.trail1 = '"+o+" Trail' or "+"segments.trail2 = '"+o+" Trail' or "+"segments.trail3 = '"+o+" Trail' or "+"segments.trail4 = '"+o+" Trail' or "+"segments.trail5 = '"+o+" Trail' or "+"segments.trail6 = '"+o+" Trail') and "+"(source = '"+d[s].properties.source+"' or "+(o=="Ohio & Erie Canal Towpath Trail")+")",a=function(e,t){return function(e){var r={type:"GET",path:"/trailsegments.json"};Lt(r,function(r){n[t]=r;e(null,s)})}}(u,i);r.push(a)}async.parallel(r,function(e,r){n=Et(n);Tt(n);Ct(t)})}function wt(e,t){console.log("getAllTrailPathsForTrailheadLocal");var n=[],r=[];for(var i=0;i<e.trails.length;i++){var s=e.trails[i],o=d[s],u=o.properties.source,a=o.properties.name,f={type:"FeatureCollection",features:[{geometry:{geometries:[],type:"GeometryCollection"},type:"Feature"}]},l=0;for(var c=0;c<m.features.length;c++){var h=$.extend(!0,{},m.features[c]);if((h.properties.trail1==a||h.properties.trail1+" Trail"==a||h.properties.trail2==a||h.properties.trail2+" Trail"==a||h.properties.trail3==a||h.properties.trail3+" Trail"==a||h.properties.trail4==a||h.properties.trail4+" Trail"==a||h.properties.trail5==a||h.properties.trail5+" Trail"==a||h.properties.trail6==a||h.properties.trail6+" Trail"==a)&&(h.properties.source==u||a=="Ohio & Erie Canal Towpath Trail")){f.features[0].properties={trailname:a};l=1;f.features[0].geometry.geometries.push(h.geometry)}}l&&r.push(f)}console.log(r);n=Et(r);Tt(n);Ct(t)}function Et(e){console.log("mergeResponses");var t=$.extend(!0,{},e[0]);t.features[0].properties.order=0;for(var n=1;n<e.length;n++){t.features=t.features.concat(e[n].features);t.features[n].properties.order=n}return t}function St(e){var t="select the_geom, name1, name2, name3 from "+_+" where 1=1";At(t,e)}function xt(e){console.log(e);var t={type:"FeatureCollection",features:[]};t.features=e.features.filter(function(e,t,n){return e.properties.trail1 in d||e.properties.trail2 in d||e.properties.trail3 in d?!1:!0});console.log(t);Tt(t)}function Tt(e){console.log("drawMultiTrailLayer");if(g){p.removeLayer(g);y=[]}e.features[0].geometry===null&&alert("No trail segment data found.");g=L.geoJson(e,{style:function(e){var t;if(e.properties.order===0||!e.properties.order){t=Nt("trail1");return{weight:3,color:t,opacity:.75}}if(e.properties.order===1){t=Nt("trail2");return{weight:3,color:t,opacity:.75}}if(e.properties.order===2){t=Nt("trail3");return{weight:3,color:t,opacity:.75}}},onEachFeature:function(e,t){var n="<div class='trail-popup'>";if(e.properties.trailname)n+=e.properties.trailname;else{e.properties.trail1&&(n=n+"<br>"+e.properties.trail1);e.properties.trail2&&(n=n+"<br>"+e.properties.trail2);e.properties.trail3&&(n=n+"<br>"+e.properties.trail3);e.properties.trail4&&(n=n+"<br>"+e.properties.trail4);e.properties.trail5&&(n=n+"<br>"+e.properties.trail5);e.properties.trail6&&(n=n+"<br>"+e.properties.trail6)}n+="</div>";t.bindPopup(n);y.push(t)}}).addTo(p).bringToBack()}function Nt(e){var t=$("<div class='"+e+"'>").hide().appendTo("body"),n=t.css("background-color");t.remove();return n}function Ct(e){console.log("setCurrentTrail");b&&typeof b.setStyle=="Function"&&b.setStyle({weight:2});b=y[e];b.setStyle({weight:10});kt(b);p.invalidateSize()}function kt(e){console.log("zoomToLayer");var t=p.getBoundsZoom(e.getBounds()),n=t>s?s:t;n=n<o?o:n;p.setView(e.getBounds().getCenter(),n,{pan:{animate:!0,duration:4,easeLinearity:.05},zoom:{animate:!0}})}function Lt(e,t){console.log("makeAPICall");$.isEmptyObject(e.data)||(e.data=JSON.stringify(e.data));var r=n+e.path,i=$.ajax({type:e.type,url:r,dataType:"json",contentType:"application/json; charset=utf-8",data:e.data}).fail(function(e,t,n){$("#results").text("error: "+JSON.stringify(n))}).done(function(e,n,r){typeof t=="function"&&t.call(this,e);$("#results").text(JSON.stringify(e))})}function At(e,t,n){console.log("makeSQLQuery");var r={q:e,format:"geoJSON"},i=$.ajax({dataType:"json",url:endpoint,data:r}).done(function(e,n,r){t(e)}).error(function(t,r,i){if(typeof n=="function")n(t);else{console.log("ERROR:");console.log(e);console.log(i)}})}console.log("trailhead.js");var e="codeforamerica.map-4urpxezk",t={lat:41.1,lng:-81.5},n="http://trailsyserver-dev.herokuapp.com";window.location.hostname.split(".")[0]=="trailsy-dev"?n="http://trailsyserver-dev.herokuapp.com":window.location.hostname.split(".")[0]=="trailsy"&&(n="http://trailsyserver-prod.herokuapp.com");var r=62137e-8,s=14,o=12,u=13,a=2,f=5,l=10,c=1,h=1,p={},d={},v=[],m=[],g={},y=[],b={},w={},E={lengthFilter:[],activityFilter:[]},S=[],x=null,T=null,N=null,C=null,k=L.Icon.extend({options:{iconSize:[20,25],iconAnchor:[20,40],popupAnchor:[-3,-75]}}),A=new k({iconUrl:"img/icon_trailhead_1.png"}),O=new k({iconUrl:"img/icon_trailhead_2.png"}),M="summit_trailheads",_="summit_trailsegments",D="summit_traildata";$("#redoSearch").click(B);$(document).on("click",".trailhead-trailname",ht);$(document).on("click",".closeDetail",at);$(document).on("click",".detailPanelControls",lt);$("#showAllTrailSegments").click(function(){St(Tt)});$("#showUnusedTrailSegments").click(function(){St(xt)});$(document).on("change",".filter",I);$(".detailPanel").hover(ft,ft);H();var mt;jQuery.fn.outerHTML=function(e){return e?this.before(e).remove():jQuery("<p>").append(this.eq(0).clone()).html()}}console.log("start");$(document).ready(startup);