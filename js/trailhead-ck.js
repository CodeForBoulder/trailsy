function startup(){function C(){}function k(){console.log("initialSetup");P();H();B(y,function(){q(function(){V(h)})});l&&z(function(){})}function A(){D();B(y,function(){V(h)})}function O(e,t){var n=$.extend(!0,{},t);$.each(t,function(t,r){if(e.activityFilter)for(var i=0;i<e.activityFilter.length;i++){var s=e.activityFilter[i];r.properties[s].toLowerCase()!=="true"&&delete n[t]}if(e.difficultyFilter){var o=!1;for(var f=0;f<e.difficultyFilter.length;f++){var l=e.difficultyFilter[f];if(r.properties.difficulty.toLowerCase()==l.toLowerCase()){o=!0;break}}o||delete n[t]}if(e.lengthFilter){var c=!1;for(var h=0;h<e.lengthFilter.length;h++){var p=e.lengthFilter[h],d=r.properties.length;if(p.toLowerCase()=="short"&&d<=u||p.toLowerCase()=="medium"&&d>u&&d<=a||p.toLowerCase()=="long"&&d>a){c=!0;break}}c||delete n[t]}});V(n)}function M(e){var t=$(e.currentTarget);console.log(t);var n=t.attr("id"),r=t.val();_(n,r)}function _(e,t){b[e]=t;console.log(b);O(b,h)}function D(){y=c.getCenter()}function P(){y=t}function H(){console.log("displayInitialMap");console.log(y);c=L.map("trailMap",{zoomControl:!1}).addControl(L.control.zoom({position:"topright"})).setView([y.lat,y.lng],11);L.tileLayer.provider("MapBox."+e).addTo(c);c.on("popupopen",function(){console.log("popupOpen")});c.on("locationfound",function(e){E||(E=L.userMarker(e.latlng,{smallIcon:!0,pulsing:!0,accuracy:0}).addTo(c));console.log(e.latlng);E.setLatLng(e.latlng)});c.locate({watch:!0,setView:!1,enableHighAccuracy:!0});c.on("zoomend",function(e){console.log("zoomend");if(f&&S){c.getZoom()>=o&&!c.hasLayer(S)&&c.addLayer(S);c.getZoom()<o&&c.hasLayer(S)&&c.removeLayer(S)}});c.on("locationerror",function(e){console.log("Location Error:");console.log(e.message);console.log(e.code)})}function B(e,t){console.log("getOrderedTrailheads");var n={loc:e.lat+","+e.lng,type:"GET",path:"/trailheads.json?loc="+e.lat+","+e.lng};wt(n,function(e){F(e);typeof t=="function"&&t()})}function j(e,t){console.log("getOrderedTrailheads");var n="select trailheads.*, ST_Distance_Sphere(ST_WKTToSQL('POINT("+e.lng+" "+e.lat+")'), the_geom) distance "+"from "+x+" as trailheads "+"ORDER BY distance "+"";Et(n,function(e){F(e);typeof t=="function"&&t()})}function F(e){console.log("populateTrailheadArray");console.log(e);p=[];for(var t=0;t<e.features.length;t++){var n=e.features[t];currentFeatureLatLng=new L.LatLng(n.geometry.coordinates[1],n.geometry.coordinates[0]);var r=L.circleMarker(currentFeatureLatLng,{title:"test",radius:4});r.on("click",function(e){return function(){I(e)}}(n.properties.id));var i={properties:n.properties,marker:r,trails:[],popupContent:""};p.push(i)}}function I(e){console.log("trailheadMarkerClick");at(e,0)}function q(e){console.log("getTrailData");var t={type:"GET",path:"/trails.json"};wt(t,function(t){U(t);typeof e=="function"&&e()})}function R(e){console.log("getTrailData");var t="select * from "+N+" order by name";Et(t,function(t){U(t);typeof e=="function"&&e()})}function U(e){for(var t=0;t<e.features.length;t++)h[e.features[t].properties.id]=e.features[t]}function z(e){console.log("getTrailSegments");var t={type:"GET",path:"/trailsegments.json"};wt(t,function(t){d=t;S=X(t);typeof e=="function"&&e()})}function W(e){console.log("getTrailSegments");var t="select the_geom, name1, name2, name3, source from "+T;Et(t,function(t){d=t;S=X(t);typeof e=="function"&&e()})}function X(e){S=L.geoJson(d,{style:function(){return{color:"#EFB589",weight:3,opacity:1,clickable:!0}},onEachFeature:function(e,t){var n="<div class='trail-popup'>";e.properties.trail1&&(n+=e.properties.trail1);e.properties.trail2&&(n=n+"<br>"+e.properties.trail2);e.properties.trail3&&(n=n+"<br>"+e.properties.trail3);e.properties.trail4&&(n=n+"<br>"+e.properties.trail4);e.properties.trail5&&(n=n+"<br>"+e.properties.trail5);e.properties.trail6&&(n=n+"<br>"+e.properties.trail6);n+="</div>";t.bindPopup(n)}});return S}function V(e){console.log("addTrailDataToTrailheads");for(var t=0;t<p.length;t++){var n=p[t];n.trails=[];for(var r=1;r<=3;r++){var i="trail"+r;if(n.properties[i]==="")continue;var s=n.properties[i];$.each(e,function(e,t){n.properties[i]==t.properties.name&&n.trails.push(e)})}}J(p);K(p);Q(p);G(p)}function J(e){console.log("fixDuplicateTrailNames");for(var t=0;t<e.length;t++){var n=e[t],r={};for(var i=0;i<n.trails.length;i++){var s=h[n.trails[i]].properties.name;r[s]=r[s]||[];var o={source:h[n.trails[i]].properties.source,trailID:h[n.trails[i]].properties.id};r[s].push(o)}for(var u in r)if(r.hasOwnProperty(u)&&r[u].length>1)for(var a=0;a<r[u].length;a++){var f=r[u][a];if(f.source!=n.properties.source){var l=f.trailID,c=$.inArray(l.toString(),n.trails);n.trails.splice(c,1)}}}}function K(e){for(var t=0;t<e.length;t++){var n=e[t],r=$("<div>").addClass("trailhead-popup"),i=$("<div>").addClass("trailhead-name").html(n.properties.name).appendTo(r);for(var s=0;s<n.trails.length;s++)var o=h[n.trails[s]],u=$("<div>").addClass("trailhead-trailname trail"+(s+1)).attr("data-trailname",o.properties.name).attr("data-trailid",o.properties.id).attr("data-trailheadname",n.properties.name).attr("data-trailheadid",n.properties.id).attr("data-index",s).append("<a href='#'>").html(o.properties.name).appendTo(i);n.popupContent=r.outerHTML()}}function Q(e){console.log("mapActiveTrailheads");var t=[];for(var n=0;n<e.length;n++)e[n].trails.length?t.push(e[n].marker):console.log(["trailhead not displayed: ",e[n].properties.name]);var r=L.layerGroup(t);c.addLayer(r)}function G(e){console.log("makeTrailDivs");$("#trailList").html("");$.each(e,function(e,t){var n=t.properties.name,r=t.properties.id,i=t.trails;if(i.length===0)return!0;var s=t.properties.source,o=Y(t.properties.distance),u;for(var a=0;a<i.length;a++){var f=i[a],l=h[f],c=h[f].properties.name;u=$("<div>").addClass("trail-box").attr("data-source","list").attr("data-trailid",f).attr("data-trailname",c).attr("data-trailheadName",n).attr("data-trailheadid",r).attr("data-index",a).appendTo("#trailList").click(st).click(function(e,t){return function(n){Z(e,t)}}(l,t));$trailIndicator=$("<div>").addClass("trailIndicatorLight").appendTo(u);$("<div class='trail' >"+c+"</div>").appendTo(u);$("<div class='trailheadName' >"+n+"</div>").appendTo(u);$("<div class='trailheadDistance' >"+o+" miles away"+"</div>").appendTo(u);$("<div class='trailSource' id='"+s+"'>"+s+"</div>").appendTo(u)}if(i.length===0){u=$("<div class='trail-box'>").appendTo("#trailList");$("<span class='trail' id='list|"+n+"'>"+n+" - NO TRAILS ("+[val.properties.trail1,val.properties.trail2,val.properties.trail3].join(", ")+")</span>").appendTo(u);$("<span class='trailSource'>"+s+"</span>").appendTo(u)}})}function Y(e){return(e*r).toFixed(1)}function Z(e,t){console.log("showTrailDetails");if(!$(".detailPanelColumn").is(":visible")){nt(e,t);et();w=e;currentDetailTrailhead=t}else if(w==e&&currentDetailTrailhead==t){w=null;currentDetailTrailhead=null;tt()}else{nt(e,t);w=e;currentDetailTrailhead=t}}function et(){console.log("openDetailPanel");$(".detailPanelColumn").show().toggleClass("col-lg-0 col-lg-3");$(".trailListColumn").toggleClass("col-lg-4 col-lg-3");$(".trailMapContainer").toggleClass("col-lg-8 col-lg-6");c.invalidateSize()}function tt(){console.log("closeDetailPanel");$(".detailPanelColumn").hide().toggleClass("col-lg-0 col-lg-3");$(".trailListColumn").toggleClass("col-lg-4 col-lg-3");$(".trailMapContainer").toggleClass("col-lg-8 col-lg-6");c.invalidateSize()}function nt(e,t){$(".detail-panel .trailName").html(e.properties.name);$(".detail-panel .detailTrailheadName").html(t.properties.name);$(".detail-panel .detailSource").html(t.properties.source);$(".detail-panel .detailTrailheadDistance").html(Y(t.properties.distance));$(".detail-panel .detailLength").html(e.properties.length);$(".detail-panel .detailDifficulty").html(e.properties.difficulty);$(".detail-panel .detailDescription").html(e.properties.description)}function rt(e){console.log("trailnameClick");ot(e)}function it(e){var t=e.data("trailheadid"),n=e.data("index")||0,r=e.data("trailid");results={trailheadID:t,highlightedTrailIndex:n,trailID:r};return results}function st(e){console.log("populateTrailsForTrailheadDiv");var t;e.target!==this?t=$(this):t=$(e.target);var n=it(t);at(n.trailheadID,n.highlightedTrailIndex)}function ot(e){var t=it($(e.target));for(var n=0;n<p.length;n++)p[n].properties.id==t.trailheadID&&(trailhead=p[n]);nt(h[t.trailID],trailhead);at(t.trailheadID,t.highlightedTrailIndex)}function at(e,t){console.log("highlightTrailhead");for(var n=0;n<p.length;n++)p[n].properties.id==e&&(currentTrailhead=p[n]);ut&&c.removeLayer(ut);ut=new L.Marker([currentTrailhead.marker.getLatLng().lat,currentTrailhead.marker.getLatLng().lng]);ut.addTo(c).bindPopup(currentTrailhead.popupContent);ft(currentTrailhead);lt(currentTrailhead,t);ut.openPopup()}function ft(e,t){console.log("highlightTrailheadDivs");$(".trail-box").removeClass("trail1").removeClass("trail2").removeClass("trail3");$(".trailIndicatorLight").hide();for(var n=0;n<currentTrailhead.trails.length;n++){var r=currentTrailhead.trails[n],i=h[r].properties.name,s=currentTrailhead.properties.name,o=currentTrailhead.properties.id,u=$('.trail-box[data-trailid="'+r+'"][data-trailheadid="'+o+'"]'),a=gt("trail"+(n+1));u.find($(".trailIndicatorLight")).css("border-color",a).show();n===0&&$("#trailList").animate({scrollTop:$('.trail-box[data-trailheadid="'+o+'"][data-index="0"]').offset().top-$("#trailList").offset().top+$("#trailList").scrollTop()},500)}}function lt(e,t){console.log("getAllTrailPathsForTrailhead");d.type=="FeatureCollection"&&l?ht(e,t):ct(e,t)}function ct(e,t){console.log("getAllTrailPathsForTrailheadRemote");var n=[],r=[];for(var i=0;i<e.trails.length;i++){var s=e.trails[i],o=h[s].properties.name,u="select st_collect(the_geom) the_geom, '"+o+"' trailname from "+T+" segments where "+"(segments.trail1 = '"+o+"' or "+"segments.trail2 = '"+o+"' or "+"segments.trail3 = '"+o+"' or "+"segments.trail4 = '"+o+"' or "+"segments.trail5 = '"+o+"' or "+"segments.trail6 = '"+o+"' or "+"segments.trail1 = '"+o+" Trail' or "+"segments.trail2 = '"+o+" Trail' or "+"segments.trail3 = '"+o+" Trail' or "+"segments.trail4 = '"+o+" Trail' or "+"segments.trail5 = '"+o+" Trail' or "+"segments.trail6 = '"+o+" Trail') and "+"(source = '"+h[s].properties.source+"' or "+(o=="Ohio & Erie Canal Towpath Trail")+")",a=function(e,t){return function(e){var r={type:"GET",path:"/trailsegments.json"};wt(r,function(r){n[t]=r;e(null,s)})}}(u,i);r.push(a)}async.parallel(r,function(e,r){n=pt(n);mt(n);yt(t)})}function ht(e,t){console.log("getAllTrailPathsForTrailheadLocal");var n=[],r=[];for(var i=0;i<e.trails.length;i++){var s=e.trails[i],o=h[s],u=o.properties.source,a=o.properties.name,f={type:"FeatureCollection",features:[{geometry:{geometries:[],type:"GeometryCollection"},type:"Feature"}]},l=0;for(var c=0;c<d.features.length;c++){var p=$.extend(!0,{},d.features[c]);if((p.properties.trail1==a||p.properties.trail1+" Trail"==a||p.properties.trail2==a||p.properties.trail2+" Trail"==a||p.properties.trail3==a||p.properties.trail3+" Trail"==a||p.properties.trail4==a||p.properties.trail4+" Trail"==a||p.properties.trail5==a||p.properties.trail5+" Trail"==a||p.properties.trail6==a||p.properties.trail6+" Trail"==a)&&(p.properties.source==u||a=="Ohio & Erie Canal Towpath Trail")){f.features[0].properties={trailname:a};l=1;f.features[0].geometry.geometries.push(p.geometry)}}l&&r.push(f)}n=pt(r);mt(n);yt(t)}function pt(e){console.log("mergeResponses");var t=$.extend(!0,{},e[0]);t.features[0].properties.order=0;for(var n=1;n<e.length;n++){t.features=t.features.concat(e[n].features);t.features[n].properties.order=n}return t}function dt(e){var t="select the_geom, name1, name2, name3 from "+T+" where 1=1";Et(t,e)}function vt(e){console.log(e);var t={type:"FeatureCollection",features:[]};t.features=e.features.filter(function(e,t,n){return e.properties.trail1 in h||e.properties.trail2 in h||e.properties.trail3 in h?!1:!0});console.log(t);mt(t)}function mt(e){console.log("drawMultiTrailLayer");if(v){c.removeLayer(v);m=[]}e.features[0].geometry===null&&alert("No trail segment data found.");v=L.geoJson(e,{style:function(e){var t;if(e.properties.order===0||!e.properties.order){t=gt("trail1");return{weight:3,color:t,opacity:.75}}if(e.properties.order===1){t=gt("trail2");return{weight:3,color:t,opacity:.75}}if(e.properties.order===2){t=gt("trail3");return{weight:3,color:t,opacity:.75}}},onEachFeature:function(e,t){var n="<div class='trail-popup'>";if(e.properties.trailname)n+=e.properties.trailname;else{e.properties.trail1&&(n=n+"<br>"+e.properties.trail1);e.properties.trail2&&(n=n+"<br>"+e.properties.trail2);e.properties.trail3&&(n=n+"<br>"+e.properties.trail3);e.properties.trail4&&(n=n+"<br>"+e.properties.trail4);e.properties.trail5&&(n=n+"<br>"+e.properties.trail5);e.properties.trail6&&(n=n+"<br>"+e.properties.trail6)}n+="</div>";t.bindPopup(n);m.push(t)}}).addTo(c).bringToBack()}function gt(e){var t=$("<div class='"+e+"'>").hide().appendTo("body"),n=t.css("background-color");t.remove();return n}function yt(e){console.log("setCurrentTrail");g&&typeof g.setStyle=="Function"&&g.setStyle({weight:2});g=m[e];g.setStyle({weight:10});bt(g);c.invalidateSize()}function bt(e){console.log("zoomToLayer");var t=c.getBoundsZoom(e.getBounds()),n=t>i?i:t;n=n<s?s:n;c.setView(e.getBounds().getCenter(),n,{pan:{animate:!0,duration:4,easeLinearity:.05},zoom:{animate:!0}})}function wt(e,t){console.log("makeAPICall");$.isEmptyObject(e.data)||(e.data=JSON.stringify(e.data));var r=n+e.path,i=$.ajax({type:e.type,url:r,dataType:"json",contentType:"application/json; charset=utf-8",data:e.data}).fail(function(e,t,n){$("#results").text("error: "+JSON.stringify(n))}).done(function(e,n,r){typeof t=="function"&&t.call(this,e);$("#results").text(JSON.stringify(e))})}function Et(e,t,n){console.log("makeSQLQuery");var r={q:e,format:"geoJSON"},i=$.ajax({dataType:"json",url:endpoint,data:r}).done(function(e,n,r){t(e)}).error(function(t,r,i){if(typeof n=="function")n(t);else{console.log("ERROR:");console.log(e);console.log(i)}})}console.log("trailhead.js");var e="codeforamerica.map-4urpxezk",t={lat:41.1,lng:-81.5},n="http://trailsyserver-dev.herokuapp.com";window.location.hostname.split(".")[0]=="trailsy-dev"?n="http://trailsyserver-dev.herokuapp.com":window.location.hostname.split(".")[0]=="trailsy"&&(n="http://trailsyserver-prod.herokuapp.com");var r=62137e-8,i=14,s=12,o=13,u=1.5,a=4,f=1,l=1,c={},h={},p=[],d=[],v={},m=[],g={},y={},b={},w=null,E=null,S=null,x="summit_trailheads",T="summit_trailsegments",N="summit_traildata";$("#redoSearch").click(A);$(document).on("click",".trailhead-trailname",rt);$(document).on("click",".closeDetail",tt);$("#showAllTrailSegments").click(function(){dt(mt)});$("#showUnusedTrailSegments").click(function(){dt(vt)});$(document).on("change",".selectpicker",M);k();var ut;jQuery.fn.outerHTML=function(e){return e?this.before(e).remove():jQuery("<p>").append(this.eq(0).clone()).html()}}$(document).ready(startup);