function startup(){function C(){}function k(){console.log("initialSetup");P();H();B(g,function(){I(function(){U(c)})});f&&R(function(){})}function A(){D();B(g,function(){U(c)})}function O(e,t){var n=$.extend(!0,{},t);$.each(t,function(t,r){if(e.activityFilter)for(var i=0;i<e.activityFilter.length;i++){var s=e.activityFilter[i];r.properties[s].toLowerCase()!=="true"&&delete n[t]}if(e.difficultyFilter){var a=!1;for(var f=0;f<e.difficultyFilter.length;f++){var l=e.difficultyFilter[f];if(r.properties.difficulty.toLowerCase()==l.toLowerCase()){a=!0;break}}a||delete n[t]}if(e.lengthFilter){var c=!1;for(var h=0;h<e.lengthFilter.length;h++){var p=e.lengthFilter[h],d=r.properties.length;if(p.toLowerCase()=="short"&&d<=o||p.toLowerCase()=="medium"&&d>o&&d<=u||p.toLowerCase()=="long"&&d>u){c=!0;break}}c||delete n[t]}});U(n)}function M(e){var t=$(e.currentTarget);console.log(t);var n=t.attr("id"),r=t.val();_(n,r)}function _(e,t){y[e]=t;console.log(y);O(y,c)}function D(){g=l.getCenter()}function P(){g=t}function H(){console.log("displayInitialMap");console.log(g);l=L.map("trailMap",{zoomControl:!0}).setView([g.lat,g.lng],11);L.tileLayer.provider("MapBox."+e).addTo(l);l.on("popupopen",function(){console.log("popupOpen")});l.on("locationfound",function(e){w||(w=L.userMarker(e.latlng,{smallIcon:!0,pulsing:!0,accuracy:0}).addTo(l));console.log(e.latlng);w.setLatLng(e.latlng)});l.locate({watch:!0,setView:!1,enableHighAccuracy:!0});l.on("zoomend",function(e){console.log("zoomend");if(a&&E){l.getZoom()>=s&&!l.hasLayer(E)&&l.addLayer(E);l.getZoom()<s&&l.hasLayer(E)&&l.removeLayer(E)}});l.on("locationerror",function(e){console.log("Location Error:");console.log(e.message);console.log(e.code)})}function B(e,t){console.log("getOrderedTrailheads");var n="select trailheads.*, ST_Distance_Sphere(ST_WKTToSQL('POINT("+e.lng+" "+e.lat+")'), the_geom) distance "+"from "+x+" as trailheads "+"ORDER BY distance "+"";mt(n,function(e){j(e);typeof t=="function"&&t()})}function j(e){console.log("populateTrailheadArray");console.log(e);h=[];for(var t=0;t<e.features.length;t++){var n=e.features[t];currentFeatureLatLng=new L.LatLng(n.geometry.coordinates[1],n.geometry.coordinates[0]);var r=L.circleMarker(currentFeatureLatLng,{title:"test",radius:4});r.on("click",function(e){return function(){F(e)}}(n.properties.cartodb_id));var i={properties:n.properties,marker:r,trails:[],popupContent:""};h.push(i)}}function F(e){console.log("trailheadMarkerClick");it(e,0)}function I(e){console.log("getTrailData");var t="select * from "+N+" order by name";mt(t,function(t){q(t);typeof e=="function"&&e()})}function q(e){for(var t=0;t<e.features.length;t++)c[e.features[t].properties.cartodb_id]=e.features[t]}function R(e){console.log("getTrailSegments");var t="select the_geom, name1, name2, name3, source from "+T;mt(t,function(t){p=t;E=L.geoJson(p,{style:function(){return{color:"#060",weight:2,opacity:.5,clickable:!0,dashArray:"5,5"}},onEachFeature:function(e,t){var n="<div class='trail-popup'>";e.properties.name1&&(n+=e.properties.name1);e.properties.name2&&(n=n+"<br>"+e.properties.name2);e.properties.name3&&(n=n+"<br>"+e.properties.name3);n+="</div>";t.bindPopup(n)}});typeof e=="function"&&e()})}function U(e){console.log("addTrailDataToTrailheads");for(var t=0;t<h.length;t++){var n=h[t];n.trails=[];for(var r=1;r<=3;r++){var i="trail"+r;if(n.properties[i]==="")continue;var s=n.properties[i];$.each(e,function(e,t){n.properties[i]==t.properties.name&&n.trails.push(e)})}}z(h);W(h);X(h);V(h)}function z(e){console.log("fixDuplicateTrailNames");for(var t=0;t<e.length;t++){var n=e[t],r={};for(var i=0;i<n.trails.length;i++){var s=c[n.trails[i]].properties.name;r[s]=r[s]||[];var o={source:c[n.trails[i]].properties.source,trailID:c[n.trails[i]].properties.cartodb_id};r[s].push(o)}for(var u in r)if(r.hasOwnProperty(u)&&r[u].length>1)for(var a=0;a<r[u].length;a++){var f=r[u][a];if(f.source!=n.properties.source){var l=f.trailID,h=$.inArray(l.toString(),n.trails);n.trails.splice(h,1)}}}}function W(e){for(var t=0;t<e.length;t++){var n=e[t],r=$("<div>").addClass("trailhead-popup"),i=$("<div>").addClass("trailhead-name").html(n.properties.name).appendTo(r);for(var s=0;s<n.trails.length;s++)var o=c[n.trails[s]],u=$("<div>").addClass("trailhead-trailname trail"+(s+1)).attr("data-trailname",o.properties.name).attr("data-trailid",o.properties.cartodb_id).attr("data-trailheadname",n.properties.name).attr("data-trailheadid",n.properties.cartodb_id).attr("data-index",s).append("<a href='#'>").html(o.properties.name).appendTo(i);n.popupContent=r.outerHTML()}}function X(e){console.log("mapActiveTrailheads");var t=[];for(var n=0;n<e.length;n++)e[n].trails.length?t.push(e[n].marker):console.log(["trailhead not displayed: ",e[n].properties.name]);var r=L.layerGroup(t);l.addLayer(r)}function V(e){console.log("makeTrailDivs");$("#trailList").html("");$.each(e,function(e,t){var n=t.properties.name,r=t.properties.cartodb_id,i=t.trails;if(i.length===0)return!0;var s=t.properties.source,o=J(t.properties.distance),u;for(var a=0;a<i.length;a++){var f=i[a],l=c[f],h=c[f].properties.name;u=$("<div>").addClass("trail-box").attr("data-source","list").attr("data-trailid",f).attr("data-trailname",h).attr("data-trailheadName",n).attr("data-trailheadid",r).attr("data-index",a).appendTo("#trailList").click(tt).click(function(e,t){return function(n){K(e,t)}}(l,t));$trailIndicator=$("<div>").addClass("trailIndicatorLight").appendTo(u);$("<div class='trail' >"+h+"</div>").appendTo(u);$("<div class='trailheadName' >"+n+"</div>").appendTo(u);$("<div class='trailheadDistance' >"+o+" miles away"+"</div>").appendTo(u);$("<div class='trailSource' id='"+s+"'>"+s+"</div>").appendTo(u)}if(i.length===0){u=$("<div class='trail-box'>").appendTo("#trailList");$("<span class='trail' id='list|"+n+"'>"+n+" - NO TRAILS ("+[val.properties.trail1,val.properties.trail2,val.properties.trail3].join(", ")+")</span>").appendTo(u);$("<span class='trailSource'>"+s+"</span>").appendTo(u)}})}function J(e){return(e*n).toFixed(1)}function K(e,t){console.log("showTrailDetails");if(!$(".detailPanelColumn").is(":visible")){Y(e,t);Q();b=e;currentDetailTrailhead=t}else if(b==e&&currentDetailTrailhead==t){b=null;currentDetailTrailhead=null;G()}else{Y(e,t);b=e;currentDetailTrailhead=t}}function Q(){console.log("openDetailPanel");$(".detailPanelColumn").show().toggleClass("col-lg-0 col-lg-3");$(".trailListColumn").toggleClass("col-lg-4 col-lg-3");$(".trailMapContainer").toggleClass("col-lg-8 col-lg-6");l.invalidateSize()}function G(){console.log("closeDetailPanel");$(".detailPanelColumn").hide().toggleClass("col-lg-0 col-lg-3");$(".trailListColumn").toggleClass("col-lg-4 col-lg-3");$(".trailMapContainer").toggleClass("col-lg-8 col-lg-6");l.invalidateSize()}function Y(e,t){$(".detail-panel .trailName").html(e.properties.name);$(".detail-panel .detailTrailheadName").html(t.properties.name);$(".detail-panel .detailSource").html(t.properties.source);$(".detail-panel .detailTrailheadDistance").html(J(t.properties.distance));$(".detail-panel .detailLength").html(e.properties.length);$(".detail-panel .detailDifficulty").html(e.properties.difficulty);$(".detail-panel .detailDescription").html(e.properties.description)}function Z(e){console.log("trailnameClick");nt(e)}function et(e){var t=e.data("trailheadid"),n=e.data("index")||0,r=e.data("trailid");results={trailheadID:t,highlightedTrailIndex:n,trailID:r};return results}function tt(e){console.log("populateTrailsForTrailheadDiv");var t;e.target!==this?t=$(this):t=$(e.target);var n=et(t);it(n.trailheadID,n.highlightedTrailIndex)}function nt(e){var t=et($(e.target));for(var n=0;n<h.length;n++)h[n].properties.cartodb_id==t.trailheadID&&(trailhead=h[n]);Y(c[t.trailID],trailhead);it(t.trailheadID,t.highlightedTrailIndex)}function it(e,t){console.log("highlightTrailhead");for(var n=0;n<h.length;n++)h[n].properties.cartodb_id==e&&(currentTrailhead=h[n]);rt&&l.removeLayer(rt);rt=new L.Marker([currentTrailhead.marker.getLatLng().lat,currentTrailhead.marker.getLatLng().lng]);rt.addTo(l).bindPopup(currentTrailhead.popupContent);st(currentTrailhead);ot(currentTrailhead,t);rt.openPopup()}function st(e,t){console.log("highlightTrailheadDivs");$(".trail-box").removeClass("trail1").removeClass("trail2").removeClass("trail3");$(".trailIndicatorLight").hide();for(var n=0;n<currentTrailhead.trails.length;n++){var r=currentTrailhead.trails[n],i=c[r].properties.name,s=currentTrailhead.properties.name,o=currentTrailhead.properties.cartodb_id,u=$('.trail-box[data-trailid="'+r+'"][data-trailheadid="'+o+'"]'),a=pt("trail"+(n+1));u.find($(".trailIndicatorLight")).css("border-color",a).show();n===0&&$("#trailList").animate({scrollTop:$('.trail-box[data-trailheadid="'+o+'"][data-index="0"]').offset().top-$("#trailList").offset().top+$("#trailList").scrollTop()},500)}}function ot(e,t){console.log("getAllTrailPathsForTrailhead");p.type=="FeatureCollection"&&f?at(e,t):ut(e,t)}function ut(e,t){console.log("getAllTrailPathsForTrailheadRemote");var n=[],r=[];for(var i=0;i<e.trails.length;i++){var s=e.trails[i],o=c[s].properties.name,u="select st_collect(the_geom) the_geom, '"+o+"' trailname from "+T+" segments where "+"(segments.name1 = '"+o+"' or "+"segments.name2 = '"+o+"' or "+"segments.name3 = '"+o+"' or "+"segments.name1 = '"+o+" Trail' or "+"segments.name2 = '"+o+" Trail' or "+"segments.name3 = '"+o+" Trail') and "+"(source = '"+c[s].properties.source+"' or "+(o=="Ohio & Erie Canal Towpath Trail")+")",a=function(e,t){return function(r){mt(e,function(e){n[t]=e;r(null,s)})}}(u,i);r.push(a)}async.parallel(r,function(e,r){n=ft(n);ht(n);dt(t)})}function at(e,t){console.log("getAllTrailPathsForTrailheadLocal");var n=[],r=[];for(var i=0;i<e.trails.length;i++){var s=e.trails[i],o=c[s],u=o.properties.source,a=o.properties.name,f={type:"FeatureCollection",features:[{geometry:{geometries:[],type:"GeometryCollection"},type:"Feature"}]},l=0;for(var h=0;h<p.features.length;h++){var d=$.extend(!0,{},p.features[h]);if((d.properties.name1==a||d.properties.name1+" Trail"==a||d.properties.name2==a||d.properties.name2+" Trail"==a||d.properties.name3==a||d.properties.name3+" Trail"==a)&&(d.properties.source==u||a=="Ohio & Erie Canal Towpath Trail")){f.features[0].properties={trailname:a};l=1;f.features[0].geometry.geometries.push(d.geometry)}}l&&r.push(f)}n=ft(r);ht(n);dt(t)}function ft(e){console.log("mergeResponses");var t=$.extend(!0,{},e[0]);t.features[0].properties.order=0;for(var n=1;n<e.length;n++){t.features=t.features.concat(e[n].features);t.features[n].properties.order=n}return t}function lt(e){var t="select the_geom, name1, name2, name3 from "+T+" where 1=1";mt(t,e)}function ct(e){console.log(e);var t={type:"FeatureCollection",features:[]};t.features=e.features.filter(function(e,t,n){return e.properties.name1 in c||e.properties.name2 in c||e.properties.name3 in c?!1:!0});console.log(t);ht(t)}function ht(e){console.log("drawMultiTrailLayer");if(d){l.removeLayer(d);v=[]}e.features[0].geometry===null&&alert("No trail segment data found.");d=L.geoJson(e,{style:function(e){var t;if(e.properties.order===0||!e.properties.order){t=pt("trail1");return{weight:3,color:t,opacity:.75}}if(e.properties.order===1){t=pt("trail2");return{weight:3,color:t,opacity:.75}}if(e.properties.order===2){t=pt("trail3");return{weight:3,color:t,opacity:.75}}},onEachFeature:function(e,t){var n="<div class='trail-popup'>";if(e.properties.trailname)n+=e.properties.trailname;else{e.properties.name1&&(n=n+"<br>"+e.properties.name1);e.properties.name2&&(n=n+"<br>"+e.properties.name2);e.properties.name3&&(n=n+"<br>"+e.properties.name3)}n+="</div>";t.bindPopup(n);v.push(t)}}).addTo(l).bringToBack()}function pt(e){var t=$("<div class='"+e+"'>").hide().appendTo("body"),n=t.css("background-color");t.remove();return n}function dt(e){console.log("setCurrentTrail");m&&typeof m.setStyle=="Function"&&m.setStyle({weight:2});m=v[e];m.setStyle({weight:10});vt(m);l.invalidateSize()}function vt(e){console.log("zoomToLayer");var t=l.getBoundsZoom(e.getBounds()),n=t>r?r:t;n=n<i?i:n;l.setView(e.getBounds().getCenter(),n,{pan:{animate:!0,duration:4,easeLinearity:.05},zoom:{animate:!0}})}function mt(e,t,n){console.log("makeSQLQuery");var r={q:e,format:"geoJSON"},i=$.ajax({dataType:"json",url:S,data:r}).done(function(e,n,r){t(e)}).error(function(t,r,i){if(typeof n=="function")n(t);else{console.log("ERROR:");console.log(e);console.log(i)}})}console.log("trailhead.js");var e="codeforamerica.map-4urpxezk",t={lat:41.1,lng:-81.5},n=62137e-8,r=14,i=12,s=13,o=1.5,u=4,a=1,f=1,l={},c={},h=[],p=[],d={},v=[],m={},g={},y={},b=null,w=null,E=null,S="http://cfa.cartodb.com/api/v2/sql/",x="summit_trailheads",T="summit_trailsegments",N="summit_traildata";$("#redoSearch").click(A);$(document).on("click",".trailhead-trailname",Z);$(document).on("click",".closeDetail",G);$("#showAllTrailSegments").click(function(){lt(ht)});$("#showUnusedTrailSegments").click(function(){lt(ct)});$(document).on("change",".selectpicker",M);k();var rt;jQuery.fn.outerHTML=function(e){return e?this.before(e).remove():jQuery("<p>").append(this.eq(0).clone()).html()}}$(document).ready(startup);